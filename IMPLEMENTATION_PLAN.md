- [x] P0: Research and select a good zod-based typesafe CLI library (e.g., `clerc`, `zod-cli`, or similar) that integrates well with Bun/TypeScript
- [x] P0: Add Bun + TypeScript setup (`package.json`, `bunfig.toml`, `tsconfig.json`) and ensure `bun run typecheck` is available
- [x] P0: Scaffold baseline project layout with `src/`, `src/lib/` (standard library), `src/domain/` (business logic), and CLI entrypoint (`src/cli.ts`)
- [x] P0: Define domain models in `src/domain/` for CLI commands and modes (Command enum: `run`, `step`, `inspect`, `init`; Mode enum: `plan`, `build`)
- [x] P0: Configure the chosen CLI library to expose exactly four core commands: `run`, `step`, `inspect`, `init`
- [x] P0: Configure `run` and `step` to require positional mode argument (`plan` or `build`), keeping parsing logic in library layer and validation in domain layer
- [x] P0: Configure `inspect` and `init` to not require a mode argument
- [x] P0: Implement help/usage output so `ralphctl --help` and `rctl --help` list only the four core commands with mode guidance
- [x] P1: Add clear error messaging for invalid/missing mode arguments, including usage guidance (domain layer validation)
- [x] P1: Wire command handler registry (stubs) in `src/lib/commands/*` with no extra commands beyond the core set
- [x] P1: Ensure business logic is decoupled from CLI library - main file (`src/cli.ts`) should use domain types, not library-specific types
- [x] P2: Add brief CLI usage reference in existing docs (optional) once help text is finalized
- [x] P0: Create a shared process runner under `src/lib/process/` (Bun.spawn-based) for CLI execution with consistent stdout/stderr capture
- [x] P0: Create a shared OpenCode CLI adapter under `src/lib/opencode/` that uses the process runner and never the SDK
- [x] P0: Add `opencode --version` availability check for `run` and `step` (fail early if unavailable)
- [x] P0: Wire `run` handler to invoke `opencode run` via the adapter (still stub logic, but CLI-based)
- [x] P0: Wire `step` handler to invoke `opencode --prompt` via the adapter (CLI-based)
- [x] P1: Add `inspect` handler implementation that uses `opencode export` through the adapter (session IDs can be stubbed for now)
- [x] P1: Add tests to assert handlers call the OpenCode CLI adapter (mocked process runner)
- [x] P0: Implement prompt resolution for `step` and add mode-aware logging to match `run` (jbtd-002-spec-002, jbtd-002-spec-001)
- [x] P0: Define and enforce loop termination behavior in `run` per jbtd-002-spec-003
  - Added `maxIterations` parameter (default: 10)
  - Implemented loop with `<promise>COMPLETE</promise>` detection
  - Added iteration markers showing progress
  - Graceful handling of max iterations and manual interruption
  - Tests for completion, max iterations, and multiple iterations
- [x] P1: Implement `step` prompt overrides per jbtd-007-spec-001/002 (mode-aware prompt arguments)
- [x] P1: Add permissions posture handling and log effective posture before first iteration (jbtd-003-spec-001/002)
- [ ] P2: Validate command expectations and `rctl` alias behaviors against jbtd-001-spec-001/003

---

## JBTD-004: Initialize Default Prompt Templates [COMPLETED]

- [x] P0: Create shared template constants in src/lib/templates/ for PROMPT_plan.md and PROMPT_build.md content (verbatim from jbtd-002-spec-002)
- [x] P0: Create shared file utility under `src/lib/files/` for safe file operations (writeFile, fileExists)
- [x] P0: Create shared user interaction utility under `src/lib/io/` for confirmation prompts (confirmOverwrite with y/N)
- [x] P0: Add `--force` flag to `init` command in CLI configuration (src/cli.ts:75-78)
- [x] P0: Implement `initHandler` in src/lib/commands/init.ts with full logic:
  - Use template constants from src/lib/templates/
  - Write PROMPT_plan.md using PLAN_TEMPLATE constant
  - Write PROMPT_build.md using BUILD_TEMPLATE constant
  - Check if files exist before writing
  - Prompt with y/N confirmation when files exist (unless --force)
  - Handle confirmation response (abort on non-y input)
- [x] P1: Add comprehensive tests for initHandler in tests/handlers.spec.ts:
  - Test writing both files to new directory (files created with correct content)
  - Test prompting for confirmation when files exist (mock user input)
  - Test --force flag bypassing confirmation (overwrites existing files)
  - Test user declining confirmation (no files written, clean abort)
  - Test idempotent behavior when files not overwritten (existing content preserved)
  - Test partial write failure handling (atomic writes, no corruption)
- [x] P1: Test edge cases for file utilities:
  - Permission denied errors (handled gracefully with error message)
  - File system errors during write (rollback behavior)
  - Concurrent writes (last write wins, but atomic per file)
- [x] P2: Add domain type for InitOptions (force flag) in src/domain/types.ts
