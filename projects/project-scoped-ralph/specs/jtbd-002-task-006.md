# Spec: Create /project:specs command

**Task ID**: 002-006
**JTBD**: JTBD-002 (Guided Planning Workflow)
**Dependencies**: None

---

## Purpose

Create a command that automatically generates one spec file per task defined in `04-tasks.md`. The command spawns isolated subagents (using Sonnet model) for each spec, where each subagent reads ONLY from filesystem artifacts (01-research.md, 02-prd.md, 03-jtbd.md, 04-tasks.md) with no access to conversation context. This validates that the planning artifacts are self-contained and complete enough for spec generation.

**Critical behavior**: Since this command spawns multiple subagents, it must CONFIRM with the user BEFORE generating. Show a summary like "Found X tasks. This will spawn X subagents to generate spec files." and ask "Proceed with spec generation? (Y/n)". Only proceed if user confirms.

---

## Scope

### In Scope
- Parse `04-tasks.md` to extract all tasks (format: `### Task XXX-YYY: Description`)
- For each task, spawn an isolated subagent that:
  - Uses Sonnet model (claude-sonnet-4-5-20250929 or equivalent)
  - Reads ONLY from filesystem: 01-research.md, 02-prd.md, 03-jtbd.md, 04-tasks.md
  - Has NO access to conversation context
  - Generates spec with: purpose, scope, acceptance criteria, implementation notes
- Create spec files in `projects/<name>/specs/` with naming: `jtbd-NNN-task-MMM.md`
- Initialize/update `IMPLEMENTATION_PLAN.md` with task list from specs
- Print next step: "Run `ralphctl run plan --project <name>` to start planning"

### Out of Scope
- Manual spec editing (user can do this afterward)
- Spec validation beyond existence check
- Automatic HLD generation (optional file, user creates manually)
- Cross-task dependency validation in specs
- Parallel subagent execution (run sequentially for stability)

---

## Acceptance Criteria

1. **Task Parsing**
   - Command successfully parses `04-tasks.md` and extracts all tasks
   - Each task is identified by JTBD-XXX and Task YYY IDs
   - Task description and dependencies are captured

2. **Subagent Isolation**
   - Each spec is generated by a new subagent instance
   - Subagent prompt explicitly states: "Read ONLY from these filesystem artifacts - do NOT use any conversation context"
   - Subagent is given exact file paths to read: 01-research.md, 02-prd.md, 03-jtbd.md, 04-tasks.md
   - Subagent uses Sonnet model (not Opus or Haiku)

3. **Spec File Generation**
   - One spec file created per task in `projects/<name>/specs/`
   - File naming follows convention: `jtbd-NNN-task-MMM.md`
   - Each spec includes:
     - Task ID and JTBD reference
     - Purpose section (what this task accomplishes)
     - Scope section (what's in/out of scope)
     - Acceptance criteria section (how to verify it's done)
     - Implementation notes section (technical guidance)
   - Dependencies are documented if present in task definition

4. **Implementation Plan**
   - `IMPLEMENTATION_PLAN.md` created/updated in project root
   - Contains list of all tasks with IDs and initial status (pending)
   - Format matches ralphctl's expected structure for plan/build loops

5. **User Feedback**
   - Progress indicator shows which spec is being generated (e.g., "Generating spec 3/23...")
   - Final summary lists all generated spec files
   - Next step message printed: "Run `ralphctl run plan --project <name>` to start planning"

6. **Error Handling**
   - If `04-tasks.md` doesn't exist, show error with suggestion to run `/project:tasks <name>`
   - If tasks file is empty or malformed, show helpful error message
   - If specs folder creation fails, surface filesystem error
   - If subagent fails, show which spec failed and continue with others

7. **Prerequisite Check**
   - Warns if `03-jtbd.md` doesn't exist (suggests running `/project:jtbd <name>`)
   - Allows user to proceed anyway if they confirm

---

## Implementation Notes

### Command Structure
```markdown
---
description: Generate spec files from task breakdown
argument-hint: <project-name>
allowed-tools: [Read, Write, Bash, Glob]
---

# /project:specs

You are writing spec files for a ralphctl project.

## Your Task

For the project `$1`:

1. **Read the tasks file**: `projects/$1/04-tasks.md`

2. **Parse all tasks**: Extract each task in format `### Task XXX-YYY: Description`

3. **For each task, spawn an isolated subagent** to write its spec:
   - Use Sonnet model (not Opus or Haiku)
   - Provide this prompt to the subagent:
     ```
     You are writing a spec file for a ralphctl project. Read ONLY from these filesystem artifacts - do NOT use any conversation context:

     1. Read: projects/$1/01-research.md
     2. Read: projects/$1/02-prd.md
     3. Read: projects/$1/03-jtbd.md
     4. Read: projects/$1/04-tasks.md

     Your task: Write a spec file for **Task XXX-YYY: <description>**

     The spec should include:
     - Purpose (what this task accomplishes)
     - Scope (what's in/out of scope)
     - Acceptance criteria (how to verify it's done)
     - Implementation notes (technical guidance)

     Write the spec to: projects/$1/specs/jtbd-XXX-task-YYY.md
     ```

4. **Track progress**: Show "Generating spec N/TOTAL..." for each spec

5. **Create/update IMPLEMENTATION_PLAN.md**: List all tasks with initial status

6. **Print next step**: "Run `ralphctl run plan --project $1` to start planning"

## Prerequisite Check

Before starting, check if `projects/$1/03-jtbd.md` exists.
- If missing: Warn "JTBD file not found. It's recommended to run `/project:jtbd $1` first. Continue anyway? (y/n)"
- If user says no, abort
- If yes, proceed

## Error Handling

- If `projects/$1/04-tasks.md` doesn't exist: "Tasks file not found. Run `/project:tasks $1` first."
- If tasks file is empty: "Tasks file is empty. Run `/project:tasks $1` to generate tasks."
- If spec generation fails: Log error, continue with remaining specs
```

### Subagent Invocation
The command should use the agent/subagent spawning mechanism available in Claude Code or OpenCode. This typically involves:
- Creating a new agent context
- Setting the model to Sonnet
- Providing the isolated prompt
- Capturing the output spec file

### Implementation Plan Format
```markdown
# Implementation Plan: <project-name>

## Tasks

- [ ] JTBD-001-Task-001: Create project folder structure
- [ ] JTBD-001-Task-002: Generate template files
- [ ] JTBD-001-Task-003: Print initialization summary
...

## Completed

(Empty initially)
```

### Task ID Parsing
Tasks follow the format:
```markdown
### Task XXX-YYY: Description
**Description**: Detailed description
**Dependencies**: Task IDs or None
**Acceptance**: Success criteria
```

Parse using regex or markdown AST:
- Heading level 3 starting with "Task"
- Extract XXX-YYY IDs
- Extract description after colon
- Read subsequent lines until next heading

### Spec File Template
Each generated spec should follow this structure:
```markdown
# Spec: <Task Description>

**Task ID**: XXX-YYY
**JTBD**: JTBD-XXX (<JTBD Name>)
**Dependencies**: <Task IDs or None>

---

## Purpose

<What this task accomplishes - 1-2 paragraphs>

---

## Scope

### In Scope
- <Specific deliverables>
- <Behaviors to implement>
- <Files to create/modify>

### Out of Scope
- <What won't be done in this task>
- <Deferred items>
- <Explicitly excluded functionality>

---

## Acceptance Criteria

1. **<Category 1>**
   - <Verifiable criterion>
   - <Verifiable criterion>

2. **<Category 2>**
   - <Verifiable criterion>
   - <Verifiable criterion>

...

---

## Implementation Notes

<Technical guidance, patterns to follow, gotchas to avoid, architectural decisions, file locations, etc.>
```

### Tool Compatibility
- **Claude Code**: Use agent spawning via skill or command chaining
- **OpenCode**: Use agent invocation API
- Both tools should produce identical spec files

### File System Operations
- Create `specs/` directory if it doesn't exist
- Use absolute paths when reading project files
- Handle spaces in project names (quote paths)

### Progress Reporting
Show real-time progress:
```
Parsing tasks... found 23 tasks
Generating specs...
  [1/23] jtbd-001-task-001.md ✓
  [2/23] jtbd-001-task-002.md ✓
  [3/23] jtbd-001-task-003.md ✗ (error: subagent timeout)
  ...
  [23/23] jtbd-004-task-006.md ✓

Summary: 22/23 specs generated successfully
Failed: jtbd-001-task-003.md (error logged)

Created IMPLEMENTATION_PLAN.md with 23 tasks

Next: Run `ralphctl run plan --project <name>` to start planning
```

---

## Verification Steps

1. **Setup Test Project**
   ```bash
   # Create test project with tasks file
   mkdir -p projects/test-project
   # Populate 04-tasks.md with sample tasks (3-5 tasks)
   ```

2. **Run Command**
   ```bash
   /project:specs test-project
   ```

3. **Verify Specs Generated**
   - Check `projects/test-project/specs/` contains one file per task
   - Verify naming: `jtbd-XXX-task-YYY.md`
   - Open each spec and confirm structure (purpose, scope, criteria, notes)
   - Verify each spec references only filesystem artifacts (no conversation context)

4. **Verify Implementation Plan**
   - Check `projects/test-project/IMPLEMENTATION_PLAN.md` exists
   - Contains all tasks from 04-tasks.md
   - Initial status is pending for all tasks

5. **Verify Subagent Isolation**
   - Review generated specs for signs of conversation context usage
   - Specs should only reference information from the 4 planning files
   - No references to "the user said" or "from our earlier discussion"

6. **Test Error Cases**
   - Run without tasks file → should show error
   - Run with empty tasks file → should show error
   - Run with malformed tasks → should handle gracefully

7. **Test Prerequisite Warning**
   - Delete 03-jtbd.md
   - Run command
   - Should warn and prompt for confirmation

---

## Related Tasks

- **002-001**: /project:research command (creates input artifact)
- **002-002**: /project:prd command (creates input artifact)
- **002-003**: /project:jtbd command (creates input artifact)
- **002-004**: /project:tasks command (creates direct input)
- **002-007**: Prerequisite warning system (depends on this)
- **002-008**: Next step messaging (depends on this)
- **003-001**: --project flag for run command (uses the generated specs)
